# Objective

Create a new PR for experimental run-make test.

# Logs

## Sync to the most recent upstream rust

```
sekineh@sekineh-VirtualBox:~$ git clone http://github.com/sekineh/rust rustme9
sekineh@sekineh-VirtualBox:~$ cd rustme9
sekineh@sekineh-VirtualBox:~/rustme9$ git remote add upstream https://github.com/rust-lang/rust

git fetch upstream
git merge upstream/master
git push
```

Confirmed my repo is updated 
```
sekineh@sekineh-VirtualBox:~/rustme9$ git show HEAD | head -1
commit 7c98d2e63f732682b057c8c453b08f9e12b262e6
```

## Create my branch

```
sekineh@sekineh-VirtualBox:~/rustme9$ git checkout -b thumb-cortex-m
```

## Implement!

Copy Makefile into the appropriate place and run with `-vv`:

```
sekineh@sekineh-VirtualBox:~/rustme9$ ./x.py test --target thumbv7m-none-eabi src/test/run-make -vv 2>&1 | tee run-make-9.log 
```

- [log for d71cc75b7c3b24b9fe942818d3a368b93fc4b189](run-make-9-1.log)
- [add -vv to cargo build](run-make-9-2.log)
- [only logs cargo output](cargo-fail-vv-9.2.log)

## Get reference log

The current `beta` is known to work fine :-)
```
sekineh@sekineh-VirtualBox:/tmp/safe_place/cortex-m$ rustc --version
rustc 1.28.0-beta.17 (922c0e0cc 2018-07-26)

sekineh@sekineh-VirtualBox:/tmp/safe_place/cortex-m$ cargo build --target thumbv7m-none-eabi -vv 2>&1 | tee ~/irr-embedded-2018/sekineh/cargo-beta-vv-9-2.log
```

- [same -vv with working beta (reference)](cargo-beta-vv-9-2.log)

## findings

### libcore is not build by `./x.py test --target thumbv7m-none-eabi src/test/run-make`

```
sekineh@sekineh-VirtualBox:~/rustme9/src/test/run-make$ ls ~/rustme9/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/thumbv7m-none-eabi/lib/
(no file here !!)
sekineh@sekineh-VirtualBox:~/rustme9/src/test/run-make$
```
Then I ran `./x.py build --target thumbv7m-none-eabi` which build something but the job failed.  I think I need to run this first.

```
sekineh@sekineh-VirtualBox:~/rustme9/src/test/run-make$ ls ~/rustme9/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/thumbv7m-none-eabi/lib
liballoc-be7b340a93cf2cc9.rlib  libcompiler_builtins-8937dfc37acfcec0.rlib  libcore-b33d847693b19528.rlib
```

## OK.  Let's begin a clean build.

```
./x.py clean
(fail) ./x.py build --target thumbv7m-none-eabi
./x.py dist --target thumbv7m-none-eabi
./x.py test --target thumbv7m-none-eabi src/test/run-make
```

Oops, `build` failed. Try `dist` and it looks better (building pile of crates).

- [log of 5af644c77bddf446c555499fc4058a3657e00fbb](to_be_added)








## Last Resort

Ultimately we can extract environment variables from strace execve logs (currently disabled for brevity).